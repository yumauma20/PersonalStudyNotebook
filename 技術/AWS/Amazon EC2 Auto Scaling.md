# 6 - 2
##　　スケーリングにまつわる課題

- ビジネスの拡大とともにマシンリソースの追加が必要
- 性格な予測は難しい
- リソースの追加
  - 自動でリソース追加で解決

## Auto Scalingとは
- 自動的にEC2インスタンスを削除したり、アプリケーションの可用性維持、コスト最適化に役立つ

- スケジュールスケーリング
  - スケジュールに基づく
    - 毎週月曜日の8時にインスタンスを2=>4台にする
    - 月曜日の午前はアクセス集中するから、逆も然り
    - マシンリソース不足でパフォーマンス劣化

- 動的スケーリング
  - 需要の変化に動的に対応する
    - CPU使用率が90%超えたらスケーリングさせる
      - 使用率が高いとパフォーマンスの劣化につながる
    - 予測ができないアクセスにはいい
    - SNSの普及とかで特定コンテンツについてのアクセス

# 6 - 3
## AWS CloudFormation

- AWS環境のコードによる管理を実現
- テンプレート定義した環境を作成/変更/削除

###　オートスケーリングのコンポーネントについて
- 起動情報を設定するテンプレート(起動テンプレート)
  - 起動情報
    - AMI(マシンイメージ)
    - インスタンスタイプ
    - ネットワーク設定など
  - 設定内容（オートスケーリンググループ）
    - どの起動テンプレートを利用するか
    - 何台構成を維持するか
    - スケールアウトの最大大数
    - 何をトリガーにするか


# 6 - 4
- 一度きりの実行や毎日毎週といったスケジュール実行が要件に合わせて可能
- マネージメントコンソールから時刻の設定を行う場合UTCで指定する必要がある。
  - JST 15:30 → UTC 06:30
- 周期的なスケジュールを設定する場合終了時刻も設定が必要

## 流れ
- 起動テンプレの作成
- オートスケーリンググループの作成
- スケジュールの設定

- CloudWatch モニタリングの詳細
  - Amazon CloudWatch を使って、インスタンスに関するメトリクスをモニタリング、収集、分析
  - 有効にすると追加料金が適用される

# 6 - 5
- オートスケーリンググループの作成
    - どの起動テンプレートを利用するか
    - 何台構成を維持するか
    - スケールアウトの最大大数
    - 何をトリガーにするか

- AutoScaling　グループの　アクティビティ履歴の中身
```
instance was started in response to a difference between desired and actual capacity, increasing the capacity from 0 to 1.
```
これで1台増やしているのがわかる

- スケジュールの設定

```
Executing scheduled action handson-schedule-6-5

instance was started in response to a difference between desired and actual capacity, increasing the capacity from 1 to 2.
``` 
２台に増えたことがわかる

- AutoScaling　グループの詳細も勝手に変わる
- これがスケジュールスケーリング
- 結構便利なんじゃね

# 6 - 6
## ターゲット追跡スケーリング

- スケーリングポリシー
  - ターゲット追跡スケーリング（今回はこれ使う）
  - ステップスケーリング
  - シンプルなスケーリング

## ターゲット追跡スケーリング
- ターゲット時を維持するようにスケールイン、スケールアウトする
- 平均CPU使用率70~80％で維持する場合

- スケールイン
  - 1システムを構成する仮想マシン（サーバー）の台数を減らすこと
- スケールアウト
  - 仮想マシンの台数を増やすこと

- スケーリングポリシー
  - 必要に応じて 平均 CPU 使用率 を 80 に維持する
  - 必要に応じて容量ユニットを追加または削除する
  - メトリクスに含める前に 300 秒 してウォームアップする

- しきい値
  - 3 分内の3データポイントのCPUUtilization > 80
  - 3回連続ってこと
  - 1分に一回データ取る

# 6 - 7
- 負荷をかける
  - 対象サーバーにSSH
    - サーバー内でCPU負荷を上げるコマンドを実行 

`stress -c 1`

--cpu で起動するプロセス数を指定する。中身は sqrt 関数を実行している。
多分こんな感じ

- SQRT関数
  - 数値の平方根を求めることが出来る関数

参考記事
https://qiita.com/sinsengumi/items/69523f6faac1fddf1877

CloudWatchで実際に閾値が超えているのを確認
→アラーム状態になる

```
instance was started in response to a difference between desired and actual capacity, increasing the capacity from 2 to 3.
```
増えていることの確認完了

# 6 - 8
- 負荷を止めてスケールイン確認
  - ターゲット追跡ポリシー

スケールインされていることの確認
4 to 3
3 to 2
となっていく
```
instance was taken out of service in response to a difference between desired and actual capacity, shrinking the capacity from 3 to 2.
```

急激なアクセス像であるがタイミング予測ができる、その後緩やかに減少

スケーリングによってインスタンスが増減するため、特定のサーバに依存するようなステートフルな作りではなく、ステートレスな作りが求められる

- ステートフル
  - スケールインでセッション情報消失
- ステートレス
  - セッション情報外だし

# 6 - 9
## 異常なインスタンスの置き換え
- EC2のステータスチェックによってELBのヘルスチェックに応じて異常なインスタンスを置き換える

- Autoスケーリンググループ内の以上なインスタンスを置き換え可用性を維持する

```
instance was launched in response to an unhealthy instance needing to be replaced.
```

これで置き換えられたことがわかる